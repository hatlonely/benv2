package reporter

import (
	"fmt"
	"io/ioutil"
	"testing"

	"github.com/hatlonely/go-kit/refx"
	jsoniter "github.com/json-iterator/go"
	. "github.com/smartystreets/goconvey/convey"

	"github.com/hatlonely/benv2/internal/recorder"
)

var testJson = `{
  "Meta": {
    "ID": "",
    "Name": "TestFramework",
    "Duration": 5000000000,
    "Parallel": [
      {
        "unit1": 3,
        "unit2": 1
      },
      {
        "unit1": 5,
        "unit2": 2
      }
    ],
    "TimeRange": [
      {
        "StartTime": "2022-12-18T17:34:20.896173+08:00",
        "EndTime": "2022-12-18T17:34:25.896173+08:00"
      },
      {
        "StartTime": "2022-12-18T17:34:26.896173+08:00",
        "EndTime": "2022-12-18T17:34:31.896173+08:00"
      }
    ]
  },
  "Metrics": [
    {
      "Summary": {
        "unit1": {
          "Total": 1318,
          "Pass": 657,
          "QPS": 131.4,
          "AvgResTimeMs": 14.634703196347031,
          "SuccessRatePercent": 49.84825493171472
        },
        "unit2": {
          "Total": 439,
          "Pass": 221,
          "QPS": 44.2,
          "AvgResTimeMs": 14.65158371040724,
          "SuccessRatePercent": 50.34168564920273
        }
      },
      "QPS": {
        "unit1": [
          {
            "Time": "2022-12-18T17:34:20.896173+08:00",
            "Value": 138
          },
          {
            "Time": "2022-12-18T17:34:21.396173+08:00",
            "Value": 132
          },
          {
            "Time": "2022-12-18T17:34:21.896173+08:00",
            "Value": 138
          },
          {
            "Time": "2022-12-18T17:34:22.396173+08:00",
            "Value": 128
          },
          {
            "Time": "2022-12-18T17:34:22.896173+08:00",
            "Value": 132
          },
          {
            "Time": "2022-12-18T17:34:23.396173+08:00",
            "Value": 134
          },
          {
            "Time": "2022-12-18T17:34:23.896173+08:00",
            "Value": 126
          },
          {
            "Time": "2022-12-18T17:34:24.396173+08:00",
            "Value": 132
          },
          {
            "Time": "2022-12-18T17:34:24.896173+08:00",
            "Value": 128
          },
          {
            "Time": "2022-12-18T17:34:25.396173+08:00",
            "Value": 126
          },
          {
            "Time": "2022-12-18T17:34:25.896173+08:00",
            "Value": 2
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-18T17:34:20.896173+08:00",
            "Value": 44
          },
          {
            "Time": "2022-12-18T17:34:21.396173+08:00",
            "Value": 44
          },
          {
            "Time": "2022-12-18T17:34:21.896173+08:00",
            "Value": 42
          },
          {
            "Time": "2022-12-18T17:34:22.396173+08:00",
            "Value": 48
          },
          {
            "Time": "2022-12-18T17:34:22.896173+08:00",
            "Value": 42
          },
          {
            "Time": "2022-12-18T17:34:23.396173+08:00",
            "Value": 42
          },
          {
            "Time": "2022-12-18T17:34:23.896173+08:00",
            "Value": 44
          },
          {
            "Time": "2022-12-18T17:34:24.396173+08:00",
            "Value": 42
          },
          {
            "Time": "2022-12-18T17:34:24.896173+08:00",
            "Value": 44
          },
          {
            "Time": "2022-12-18T17:34:25.396173+08:00",
            "Value": 50
          },
          {
            "Time": "2022-12-18T17:34:25.896173+08:00",
            "Value": 2
          }
        ]
      },
      "AvgResTimeMs": {
        "unit1": [
          {
            "Time": "2022-12-18T17:34:20.896173+08:00",
            "Value": 13.855072463768115
          },
          {
            "Time": "2022-12-18T17:34:21.396173+08:00",
            "Value": 14.484848484848484
          },
          {
            "Time": "2022-12-18T17:34:21.896173+08:00",
            "Value": 14.46376811594203
          },
          {
            "Time": "2022-12-18T17:34:22.396173+08:00",
            "Value": 14.59375
          },
          {
            "Time": "2022-12-18T17:34:22.896173+08:00",
            "Value": 14.954545454545455
          },
          {
            "Time": "2022-12-18T17:34:23.396173+08:00",
            "Value": 14.656716417910447
          },
          {
            "Time": "2022-12-18T17:34:23.896173+08:00",
            "Value": 15.238095238095237
          },
          {
            "Time": "2022-12-18T17:34:24.396173+08:00",
            "Value": 14.757575757575758
          },
          {
            "Time": "2022-12-18T17:34:24.896173+08:00",
            "Value": 15.09375
          },
          {
            "Time": "2022-12-18T17:34:25.396173+08:00",
            "Value": 14.253968253968255
          },
          {
            "Time": "2022-12-18T17:34:25.896173+08:00",
            "Value": 18
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-18T17:34:20.896173+08:00",
            "Value": 14.5
          },
          {
            "Time": "2022-12-18T17:34:21.396173+08:00",
            "Value": 15.045454545454545
          },
          {
            "Time": "2022-12-18T17:34:21.896173+08:00",
            "Value": 14.333333333333334
          },
          {
            "Time": "2022-12-18T17:34:22.396173+08:00",
            "Value": 14.208333333333334
          },
          {
            "Time": "2022-12-18T17:34:22.896173+08:00",
            "Value": 15.047619047619047
          },
          {
            "Time": "2022-12-18T17:34:23.396173+08:00",
            "Value": 14.238095238095237
          },
          {
            "Time": "2022-12-18T17:34:23.896173+08:00",
            "Value": 14.954545454545455
          },
          {
            "Time": "2022-12-18T17:34:24.396173+08:00",
            "Value": 14.238095238095237
          },
          {
            "Time": "2022-12-18T17:34:24.896173+08:00",
            "Value": 15.272727272727273
          },
          {
            "Time": "2022-12-18T17:34:25.396173+08:00",
            "Value": 14.52
          },
          {
            "Time": "2022-12-18T17:34:25.896173+08:00",
            "Value": 14
          }
        ]
      },
      "SuccessRatePercent": {
        "unit1": [
          {
            "Time": "2022-12-18T17:34:20.896173+08:00",
            "Value": 50.73529411764706
          },
          {
            "Time": "2022-12-18T17:34:21.396173+08:00",
            "Value": 49.25373134328358
          },
          {
            "Time": "2022-12-18T17:34:21.896173+08:00",
            "Value": 52.27272727272727
          },
          {
            "Time": "2022-12-18T17:34:22.396173+08:00",
            "Value": 48.1203007518797
          },
          {
            "Time": "2022-12-18T17:34:22.896173+08:00",
            "Value": 51.16279069767442
          },
          {
            "Time": "2022-12-18T17:34:23.396173+08:00",
            "Value": 51.14503816793893
          },
          {
            "Time": "2022-12-18T17:34:23.896173+08:00",
            "Value": 49.60629921259842
          },
          {
            "Time": "2022-12-18T17:34:24.396173+08:00",
            "Value": 50.76923076923077
          },
          {
            "Time": "2022-12-18T17:34:24.896173+08:00",
            "Value": 49.23076923076923
          },
          {
            "Time": "2022-12-18T17:34:25.396173+08:00",
            "Value": 46.3235294117647
          },
          {
            "Time": "2022-12-18T17:34:25.896173+08:00",
            "Value": 33.333333333333336
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-18T17:34:20.896173+08:00",
            "Value": 46.808510638297875
          },
          {
            "Time": "2022-12-18T17:34:21.396173+08:00",
            "Value": 51.16279069767442
          },
          {
            "Time": "2022-12-18T17:34:21.896173+08:00",
            "Value": 44.680851063829785
          },
          {
            "Time": "2022-12-18T17:34:22.396173+08:00",
            "Value": 54.54545454545455
          },
          {
            "Time": "2022-12-18T17:34:22.896173+08:00",
            "Value": 47.72727272727273
          },
          {
            "Time": "2022-12-18T17:34:23.396173+08:00",
            "Value": 45.65217391304348
          },
          {
            "Time": "2022-12-18T17:34:23.896173+08:00",
            "Value": 52.38095238095238
          },
          {
            "Time": "2022-12-18T17:34:24.396173+08:00",
            "Value": 47.72727272727273
          },
          {
            "Time": "2022-12-18T17:34:24.896173+08:00",
            "Value": 52.38095238095238
          },
          {
            "Time": "2022-12-18T17:34:25.396173+08:00",
            "Value": 62.5
          },
          {
            "Time": "2022-12-18T17:34:25.896173+08:00",
            "Value": 100
          }
        ]
      },
      "ErrCodeDistribution": {
        "unit1": {
          "OK": 658,
          "val3 val4": 663
        },
        "unit2": {
          "OK": 222,
          "val3 val4": 218
        }
      }
    },
    {
      "Summary": {
        "unit1": {
          "Total": 1059,
          "Pass": 518,
          "QPS": 103.6,
          "AvgResTimeMs": 30.01930501930502,
          "SuccessRatePercent": 48.91406987724268
        },
        "unit2": {
          "Total": 412,
          "Pass": 217,
          "QPS": 43.4,
          "AvgResTimeMs": 30.253456221198157,
          "SuccessRatePercent": 52.66990291262136
        }
      },
      "QPS": {
        "unit1": [
          {
            "Time": "2022-12-18T17:34:26.896173+08:00",
            "Value": 106
          },
          {
            "Time": "2022-12-18T17:34:27.396173+08:00",
            "Value": 108
          },
          {
            "Time": "2022-12-18T17:34:27.896173+08:00",
            "Value": 106
          },
          {
            "Time": "2022-12-18T17:34:28.396173+08:00",
            "Value": 106
          },
          {
            "Time": "2022-12-18T17:34:28.896173+08:00",
            "Value": 112
          },
          {
            "Time": "2022-12-18T17:34:29.396173+08:00",
            "Value": 106
          },
          {
            "Time": "2022-12-18T17:34:29.896173+08:00",
            "Value": 106
          },
          {
            "Time": "2022-12-18T17:34:30.396173+08:00",
            "Value": 110
          },
          {
            "Time": "2022-12-18T17:34:30.896173+08:00",
            "Value": 108
          },
          {
            "Time": "2022-12-18T17:34:31.396173+08:00",
            "Value": 68
          },
          {
            "Time": "2022-12-18T17:34:31.896173+08:00",
            "Value": 6
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-18T17:34:26.896173+08:00",
            "Value": 46
          },
          {
            "Time": "2022-12-18T17:34:27.396173+08:00",
            "Value": 46
          },
          {
            "Time": "2022-12-18T17:34:27.896173+08:00",
            "Value": 42
          },
          {
            "Time": "2022-12-18T17:34:28.396173+08:00",
            "Value": 50
          },
          {
            "Time": "2022-12-18T17:34:28.896173+08:00",
            "Value": 44
          },
          {
            "Time": "2022-12-18T17:34:29.396173+08:00",
            "Value": 40
          },
          {
            "Time": "2022-12-18T17:34:29.896173+08:00",
            "Value": 46
          },
          {
            "Time": "2022-12-18T17:34:30.396173+08:00",
            "Value": 44
          },
          {
            "Time": "2022-12-18T17:34:30.896173+08:00",
            "Value": 42
          },
          {
            "Time": "2022-12-18T17:34:31.396173+08:00",
            "Value": 34
          },
          {
            "Time": "2022-12-18T17:34:31.896173+08:00",
            "Value": 2
          }
        ]
      },
      "AvgResTimeMs": {
        "unit1": [
          {
            "Time": "2022-12-18T17:34:26.896173+08:00",
            "Value": 28.735849056603772
          },
          {
            "Time": "2022-12-18T17:34:27.396173+08:00",
            "Value": 28.48148148148148
          },
          {
            "Time": "2022-12-18T17:34:27.896173+08:00",
            "Value": 29.056603773584907
          },
          {
            "Time": "2022-12-18T17:34:28.396173+08:00",
            "Value": 29.41509433962264
          },
          {
            "Time": "2022-12-18T17:34:28.896173+08:00",
            "Value": 28.339285714285715
          },
          {
            "Time": "2022-12-18T17:34:29.396173+08:00",
            "Value": 30.37735849056604
          },
          {
            "Time": "2022-12-18T17:34:29.896173+08:00",
            "Value": 28.943396226415093
          },
          {
            "Time": "2022-12-18T17:34:30.396173+08:00",
            "Value": 29.527272727272727
          },
          {
            "Time": "2022-12-18T17:34:30.896173+08:00",
            "Value": 29.74074074074074
          },
          {
            "Time": "2022-12-18T17:34:31.396173+08:00",
            "Value": 41.911764705882355
          },
          {
            "Time": "2022-12-18T17:34:31.896173+08:00",
            "Value": 32
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-18T17:34:26.896173+08:00",
            "Value": 27.695652173913043
          },
          {
            "Time": "2022-12-18T17:34:27.396173+08:00",
            "Value": 29.217391304347824
          },
          {
            "Time": "2022-12-18T17:34:27.896173+08:00",
            "Value": 30.61904761904762
          },
          {
            "Time": "2022-12-18T17:34:28.396173+08:00",
            "Value": 27.32
          },
          {
            "Time": "2022-12-18T17:34:28.896173+08:00",
            "Value": 28.40909090909091
          },
          {
            "Time": "2022-12-18T17:34:29.396173+08:00",
            "Value": 30.2
          },
          {
            "Time": "2022-12-18T17:34:29.896173+08:00",
            "Value": 28
          },
          {
            "Time": "2022-12-18T17:34:30.396173+08:00",
            "Value": 31.09090909090909
          },
          {
            "Time": "2022-12-18T17:34:30.896173+08:00",
            "Value": 29.666666666666668
          },
          {
            "Time": "2022-12-18T17:34:31.396173+08:00",
            "Value": 43.8235294117647
          },
          {
            "Time": "2022-12-18T17:34:31.896173+08:00",
            "Value": 25
          }
        ]
      },
      "SuccessRatePercent": {
        "unit1": [
          {
            "Time": "2022-12-18T17:34:26.896173+08:00",
            "Value": 48.18181818181818
          },
          {
            "Time": "2022-12-18T17:34:27.396173+08:00",
            "Value": 48.214285714285715
          },
          {
            "Time": "2022-12-18T17:34:27.896173+08:00",
            "Value": 48.62385321100918
          },
          {
            "Time": "2022-12-18T17:34:28.396173+08:00",
            "Value": 49.074074074074076
          },
          {
            "Time": "2022-12-18T17:34:28.896173+08:00",
            "Value": 50.450450450450454
          },
          {
            "Time": "2022-12-18T17:34:29.396173+08:00",
            "Value": 50
          },
          {
            "Time": "2022-12-18T17:34:29.896173+08:00",
            "Value": 47.747747747747745
          },
          {
            "Time": "2022-12-18T17:34:30.396173+08:00",
            "Value": 50.45871559633027
          },
          {
            "Time": "2022-12-18T17:34:30.896173+08:00",
            "Value": 49.54128440366973
          },
          {
            "Time": "2022-12-18T17:34:31.396173+08:00",
            "Value": 45.945945945945944
          },
          {
            "Time": "2022-12-18T17:34:31.896173+08:00",
            "Value": 60
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-18T17:34:26.896173+08:00",
            "Value": 53.48837209302326
          },
          {
            "Time": "2022-12-18T17:34:27.396173+08:00",
            "Value": 54.76190476190476
          },
          {
            "Time": "2022-12-18T17:34:27.896173+08:00",
            "Value": 52.5
          },
          {
            "Time": "2022-12-18T17:34:28.396173+08:00",
            "Value": 54.34782608695652
          },
          {
            "Time": "2022-12-18T17:34:28.896173+08:00",
            "Value": 47.82608695652174
          },
          {
            "Time": "2022-12-18T17:34:29.396173+08:00",
            "Value": 48.78048780487805
          },
          {
            "Time": "2022-12-18T17:34:29.896173+08:00",
            "Value": 54.76190476190476
          },
          {
            "Time": "2022-12-18T17:34:30.396173+08:00",
            "Value": 51.16279069767442
          },
          {
            "Time": "2022-12-18T17:34:30.896173+08:00",
            "Value": 50
          },
          {
            "Time": "2022-12-18T17:34:31.396173+08:00",
            "Value": 62.96296296296296
          },
          {
            "Time": "2022-12-18T17:34:31.896173+08:00",
            "Value": 50
          }
        ]
      },
      "ErrCodeDistribution": {
        "unit1": {
          "OK": 521,
          "val3 val4": 543
        },
        "unit2": {
          "OK": 218,
          "val3 val4": 196
        }
      }
    }
  ],
  "Monitors": [
    {
      "acs_ecs_dashboard.CPUUtilization": {
        "i-uf6d23s4d6t1x6rpdmld": [
          {
            "Time": "2022-12-18T17:25:00+08:00",
            "Value": 6.493
          },
          {
            "Time": "2022-12-18T17:26:00+08:00",
            "Value": 6.489
          },
          {
            "Time": "2022-12-18T17:27:00+08:00",
            "Value": 6.552
          },
          {
            "Time": "2022-12-18T17:28:00+08:00",
            "Value": 6.554
          },
          {
            "Time": "2022-12-18T17:29:00+08:00",
            "Value": 6.576
          },
          {
            "Time": "2022-12-18T17:30:00+08:00",
            "Value": 6.583
          },
          {
            "Time": "2022-12-18T17:31:00+08:00",
            "Value": 6.632
          },
          {
            "Time": "2022-12-18T17:32:00+08:00",
            "Value": 6.742
          },
          {
            "Time": "2022-12-18T17:33:00+08:00",
            "Value": 6.57
          },
          {
            "Time": "2022-12-18T17:34:00+08:00",
            "Value": 6.831
          }
        ]
      }
    },
    {
      "acs_ecs_dashboard.CPUUtilization": {
        "i-uf6d23s4d6t1x6rpdmld": [
          {
            "Time": "2022-12-18T17:25:00+08:00",
            "Value": 6.493
          },
          {
            "Time": "2022-12-18T17:26:00+08:00",
            "Value": 6.489
          },
          {
            "Time": "2022-12-18T17:27:00+08:00",
            "Value": 6.552
          },
          {
            "Time": "2022-12-18T17:28:00+08:00",
            "Value": 6.554
          },
          {
            "Time": "2022-12-18T17:29:00+08:00",
            "Value": 6.576
          },
          {
            "Time": "2022-12-18T17:30:00+08:00",
            "Value": 6.583
          },
          {
            "Time": "2022-12-18T17:31:00+08:00",
            "Value": 6.632
          },
          {
            "Time": "2022-12-18T17:32:00+08:00",
            "Value": 6.742
          },
          {
            "Time": "2022-12-18T17:33:00+08:00",
            "Value": 6.57
          },
          {
            "Time": "2022-12-18T17:34:00+08:00",
            "Value": 6.831
          }
        ]
      }
    }
  ]
}`

type metaMetric struct {
	Meta     *recorder.Meta
	Metrics  []*recorder.Metric
	Monitors []map[string]map[string][]*recorder.Measurement
}

func loadMetaMetric() (meta *recorder.Meta, metrics []*recorder.Metric, monitors []map[string]map[string][]*recorder.Measurement) {
	var v metaMetric
	jsoniter.UnmarshalFromString(testJson, &v)
	return v.Meta, v.Metrics, v.Monitors
}

func TestReporterJson(t *testing.T) {
	meta, metrics, monitors := loadMetaMetric()

	Convey("TestReporterJson", t, func() {
		reporter, err := NewReporterWithOptions(&refx.TypeOptions{
			Type: "Json",
		})
		So(err, ShouldBeNil)
		fmt.Println(reporter.Report(meta, metrics, monitors))
	})
}

func TestReporterText(t *testing.T) {
	meta, metrics, monitors := loadMetaMetric()

	Convey("TestReporterText", t, func() {
		reporter, err := NewReporterWithOptions(&refx.TypeOptions{
			Type: "Text",
			Options: &TextReporterOptions{
				TitleWidth: 20,
				ValueWidth: 9,
			},
		})
		So(err, ShouldBeNil)
		fmt.Println(reporter.Report(meta, metrics, monitors))
	})
}

func TestReporterHtml(t *testing.T) {
	meta, metrics, monitors := loadMetaMetric()

	Convey("TestReporterHtml", t, func() {
		reporter, err := NewReporterWithOptions(&refx.TypeOptions{
			Type: "Html",
		})
		So(err, ShouldBeNil)
		ioutil.WriteFile("1.html", []byte(reporter.Report(meta, metrics, monitors)), 0644)
	})
}
