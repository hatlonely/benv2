package reporter

import (
	"fmt"
	"testing"

	"github.com/hatlonely/go-kit/refx"
	jsoniter "github.com/json-iterator/go"
	. "github.com/smartystreets/goconvey/convey"

	"github.com/hatlonely/benv2/internal/recorder"
)

var testJson = `{
  "Meta": {
    "ID": "",
    "Name": "TestFramework",
    "Duration": 5000000000,
    "Parallel": [
      {
        "unit1": 3,
        "unit2": 1
      },
      {
        "unit1": 5,
        "unit2": 2
      }
    ],
    "TimeRange": [
      {
        "StartTime": "2022-12-16T22:06:56.793862+08:00",
        "EndTime": "2022-12-16T22:07:01.793862+08:00"
      },
      {
        "StartTime": "2022-12-16T22:07:02.793862+08:00",
        "EndTime": "2022-12-16T22:07:07.793862+08:00"
      }
    ]
  },
  "Metrics": [
    {
      "Summary": {
        "unit1": {
          "Total": 1222,
          "Pass": 616,
          "QPS": 123.2,
          "AvgResTimeMs": 15.876623376623376,
          "SuccessRatePercent": 50.40916530278233
        },
        "unit2": {
          "Total": 412,
          "Pass": 200,
          "QPS": 40,
          "AvgResTimeMs": 15.78,
          "SuccessRatePercent": 48.54368932038835
        }
      },
      "QPS": {
        "unit1": [
          {
            "Time": "2022-12-16T22:06:56.793862+08:00",
            "Value": 116
          },
          {
            "Time": "2022-12-16T22:06:57.293862+08:00",
            "Value": 110
          },
          {
            "Time": "2022-12-16T22:06:57.793862+08:00",
            "Value": 110
          },
          {
            "Time": "2022-12-16T22:06:58.293862+08:00",
            "Value": 124
          },
          {
            "Time": "2022-12-16T22:06:58.793862+08:00",
            "Value": 140
          },
          {
            "Time": "2022-12-16T22:06:59.293862+08:00",
            "Value": 122
          },
          {
            "Time": "2022-12-16T22:06:59.793862+08:00",
            "Value": 122
          },
          {
            "Time": "2022-12-16T22:07:00.293862+08:00",
            "Value": 136
          },
          {
            "Time": "2022-12-16T22:07:00.793862+08:00",
            "Value": 130
          },
          {
            "Time": "2022-12-16T22:07:01.293862+08:00",
            "Value": 122
          },
          {
            "Time": "2022-12-16T22:07:01.793862+08:00",
            "Value": 4
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-16T22:06:56.793862+08:00",
            "Value": 38
          },
          {
            "Time": "2022-12-16T22:06:57.293862+08:00",
            "Value": 34
          },
          {
            "Time": "2022-12-16T22:06:57.793862+08:00",
            "Value": 36
          },
          {
            "Time": "2022-12-16T22:06:58.293862+08:00",
            "Value": 42
          },
          {
            "Time": "2022-12-16T22:06:58.793862+08:00",
            "Value": 40
          },
          {
            "Time": "2022-12-16T22:06:59.293862+08:00",
            "Value": 42
          },
          {
            "Time": "2022-12-16T22:06:59.793862+08:00",
            "Value": 36
          },
          {
            "Time": "2022-12-16T22:07:00.293862+08:00",
            "Value": 50
          },
          {
            "Time": "2022-12-16T22:07:00.793862+08:00",
            "Value": 44
          },
          {
            "Time": "2022-12-16T22:07:01.293862+08:00",
            "Value": 38
          },
          {
            "Time": "2022-12-16T22:07:01.793862+08:00",
            "Value": 2
          }
        ]
      },
      "AvgResTimeMs": {
        "unit1": [
          {
            "Time": "2022-12-16T22:06:56.793862+08:00",
            "Value": 15.724137931034482
          },
          {
            "Time": "2022-12-16T22:06:57.293862+08:00",
            "Value": 18.472727272727273
          },
          {
            "Time": "2022-12-16T22:06:57.793862+08:00",
            "Value": 18.236363636363638
          },
          {
            "Time": "2022-12-16T22:06:58.293862+08:00",
            "Value": 15.193548387096774
          },
          {
            "Time": "2022-12-16T22:06:58.793862+08:00",
            "Value": 14.742857142857142
          },
          {
            "Time": "2022-12-16T22:06:59.293862+08:00",
            "Value": 16.147540983606557
          },
          {
            "Time": "2022-12-16T22:06:59.793862+08:00",
            "Value": 16.34426229508197
          },
          {
            "Time": "2022-12-16T22:07:00.293862+08:00",
            "Value": 13.794117647058824
          },
          {
            "Time": "2022-12-16T22:07:00.793862+08:00",
            "Value": 14.753846153846155
          },
          {
            "Time": "2022-12-16T22:07:01.293862+08:00",
            "Value": 16.24590163934426
          },
          {
            "Time": "2022-12-16T22:07:01.793862+08:00",
            "Value": 11
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-16T22:06:56.793862+08:00",
            "Value": 16.05263157894737
          },
          {
            "Time": "2022-12-16T22:06:57.293862+08:00",
            "Value": 17.294117647058822
          },
          {
            "Time": "2022-12-16T22:06:57.793862+08:00",
            "Value": 17.833333333333332
          },
          {
            "Time": "2022-12-16T22:06:58.293862+08:00",
            "Value": 15.666666666666666
          },
          {
            "Time": "2022-12-16T22:06:58.793862+08:00",
            "Value": 14.05
          },
          {
            "Time": "2022-12-16T22:06:59.293862+08:00",
            "Value": 16.476190476190474
          },
          {
            "Time": "2022-12-16T22:06:59.793862+08:00",
            "Value": 16.944444444444443
          },
          {
            "Time": "2022-12-16T22:07:00.293862+08:00",
            "Value": 14.04
          },
          {
            "Time": "2022-12-16T22:07:00.793862+08:00",
            "Value": 14.454545454545455
          },
          {
            "Time": "2022-12-16T22:07:01.293862+08:00",
            "Value": 15.842105263157896
          },
          {
            "Time": "2022-12-16T22:07:01.793862+08:00",
            "Value": 9
          }
        ]
      },
      "SuccessRatePercent": {
        "unit1": [
          {
            "Time": "2022-12-16T22:06:56.793862+08:00",
            "Value": 50
          },
          {
            "Time": "2022-12-16T22:06:57.293862+08:00",
            "Value": 51.401869158878505
          },
          {
            "Time": "2022-12-16T22:06:57.793862+08:00",
            "Value": 49.549549549549546
          },
          {
            "Time": "2022-12-16T22:06:58.293862+08:00",
            "Value": 50.40650406504065
          },
          {
            "Time": "2022-12-16T22:06:58.793862+08:00",
            "Value": 53.03030303030303
          },
          {
            "Time": "2022-12-16T22:06:59.293862+08:00",
            "Value": 49.59349593495935
          },
          {
            "Time": "2022-12-16T22:06:59.793862+08:00",
            "Value": 51.260504201680675
          },
          {
            "Time": "2022-12-16T22:07:00.293862+08:00",
            "Value": 48.226950354609926
          },
          {
            "Time": "2022-12-16T22:07:00.793862+08:00",
            "Value": 48.87218045112782
          },
          {
            "Time": "2022-12-16T22:07:01.293862+08:00",
            "Value": 52.136752136752136
          },
          {
            "Time": "2022-12-16T22:07:01.793862+08:00",
            "Value": 66.66666666666667
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-16T22:06:56.793862+08:00",
            "Value": 48.717948717948715
          },
          {
            "Time": "2022-12-16T22:06:57.293862+08:00",
            "Value": 44.73684210526316
          },
          {
            "Time": "2022-12-16T22:06:57.793862+08:00",
            "Value": 51.42857142857143
          },
          {
            "Time": "2022-12-16T22:06:58.293862+08:00",
            "Value": 48.83720930232558
          },
          {
            "Time": "2022-12-16T22:06:58.793862+08:00",
            "Value": 41.666666666666664
          },
          {
            "Time": "2022-12-16T22:06:59.293862+08:00",
            "Value": 51.21951219512195
          },
          {
            "Time": "2022-12-16T22:06:59.793862+08:00",
            "Value": 46.15384615384615
          },
          {
            "Time": "2022-12-16T22:07:00.293862+08:00",
            "Value": 56.81818181818182
          },
          {
            "Time": "2022-12-16T22:07:00.793862+08:00",
            "Value": 52.38095238095238
          },
          {
            "Time": "2022-12-16T22:07:01.293862+08:00",
            "Value": 44.18604651162791
          },
          {
            "Time": "2022-12-16T22:07:01.793862+08:00",
            "Value": 100
          }
        ]
      },
      "ErrCodeDistribution": {
        "unit1": {
          "OK": 618,
          "val3 val4": 607
        },
        "unit2": {
          "OK": 201,
          "val3 val4": 212
        }
      }
    },
    {
      "Summary": {
        "unit1": {
          "Total": 916,
          "Pass": 459,
          "QPS": 91.8,
          "AvgResTimeMs": 34.48366013071895,
          "SuccessRatePercent": 50.109170305676855
        },
        "unit2": {
          "Total": 372,
          "Pass": 184,
          "QPS": 36.8,
          "AvgResTimeMs": 33.42934782608695,
          "SuccessRatePercent": 49.46236559139785
        }
      },
      "QPS": {
        "unit1": [
          {
            "Time": "2022-12-16T22:07:02.793862+08:00",
            "Value": 86
          },
          {
            "Time": "2022-12-16T22:07:03.293862+08:00",
            "Value": 88
          },
          {
            "Time": "2022-12-16T22:07:03.793862+08:00",
            "Value": 84
          },
          {
            "Time": "2022-12-16T22:07:04.293862+08:00",
            "Value": 98
          },
          {
            "Time": "2022-12-16T22:07:04.793862+08:00",
            "Value": 78
          },
          {
            "Time": "2022-12-16T22:07:05.293862+08:00",
            "Value": 68
          },
          {
            "Time": "2022-12-16T22:07:05.793862+08:00",
            "Value": 108
          },
          {
            "Time": "2022-12-16T22:07:06.293862+08:00",
            "Value": 114
          },
          {
            "Time": "2022-12-16T22:07:06.793862+08:00",
            "Value": 82
          },
          {
            "Time": "2022-12-16T22:07:07.293862+08:00",
            "Value": 112
          },
          {
            "Time": "2022-12-16T22:07:07.793862+08:00",
            "Value": 6
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-16T22:07:02.793862+08:00",
            "Value": 34
          },
          {
            "Time": "2022-12-16T22:07:03.293862+08:00",
            "Value": 42
          },
          {
            "Time": "2022-12-16T22:07:03.793862+08:00",
            "Value": 40
          },
          {
            "Time": "2022-12-16T22:07:04.293862+08:00",
            "Value": 32
          },
          {
            "Time": "2022-12-16T22:07:04.793862+08:00",
            "Value": 36
          },
          {
            "Time": "2022-12-16T22:07:05.293862+08:00",
            "Value": 24
          },
          {
            "Time": "2022-12-16T22:07:05.793862+08:00",
            "Value": 34
          },
          {
            "Time": "2022-12-16T22:07:06.293862+08:00",
            "Value": 48
          },
          {
            "Time": "2022-12-16T22:07:06.793862+08:00",
            "Value": 34
          },
          {
            "Time": "2022-12-16T22:07:07.293862+08:00",
            "Value": 44
          },
          {
            "Time": "2022-12-16T22:07:07.793862+08:00",
            "Value": 4
          }
        ]
      },
      "AvgResTimeMs": {
        "unit1": [
          {
            "Time": "2022-12-16T22:07:02.793862+08:00",
            "Value": 35.13953488372093
          },
          {
            "Time": "2022-12-16T22:07:03.293862+08:00",
            "Value": 33.36363636363637
          },
          {
            "Time": "2022-12-16T22:07:03.793862+08:00",
            "Value": 36.04761904761905
          },
          {
            "Time": "2022-12-16T22:07:04.293862+08:00",
            "Value": 35.265306122448976
          },
          {
            "Time": "2022-12-16T22:07:04.793862+08:00",
            "Value": 38.94871794871795
          },
          {
            "Time": "2022-12-16T22:07:05.293862+08:00",
            "Value": 49.088235294117645
          },
          {
            "Time": "2022-12-16T22:07:05.793862+08:00",
            "Value": 31.203703703703702
          },
          {
            "Time": "2022-12-16T22:07:06.293862+08:00",
            "Value": 26.56140350877193
          },
          {
            "Time": "2022-12-16T22:07:06.793862+08:00",
            "Value": 39.34146341463415
          },
          {
            "Time": "2022-12-16T22:07:07.293862+08:00",
            "Value": 28.607142857142858
          },
          {
            "Time": "2022-12-16T22:07:07.793862+08:00",
            "Value": 24.333333333333332
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-16T22:07:02.793862+08:00",
            "Value": 34.294117647058826
          },
          {
            "Time": "2022-12-16T22:07:03.293862+08:00",
            "Value": 32.095238095238095
          },
          {
            "Time": "2022-12-16T22:07:03.793862+08:00",
            "Value": 35.2
          },
          {
            "Time": "2022-12-16T22:07:04.293862+08:00",
            "Value": 33.125
          },
          {
            "Time": "2022-12-16T22:07:04.793862+08:00",
            "Value": 38.55555555555556
          },
          {
            "Time": "2022-12-16T22:07:05.293862+08:00",
            "Value": 47.583333333333336
          },
          {
            "Time": "2022-12-16T22:07:05.793862+08:00",
            "Value": 29.88235294117647
          },
          {
            "Time": "2022-12-16T22:07:06.293862+08:00",
            "Value": 27.5
          },
          {
            "Time": "2022-12-16T22:07:06.793862+08:00",
            "Value": 36.588235294117645
          },
          {
            "Time": "2022-12-16T22:07:07.293862+08:00",
            "Value": 27.363636363636363
          },
          {
            "Time": "2022-12-16T22:07:07.793862+08:00",
            "Value": 20.5
          }
        ]
      },
      "SuccessRatePercent": {
        "unit1": [
          {
            "Time": "2022-12-16T22:07:02.793862+08:00",
            "Value": 50.588235294117645
          },
          {
            "Time": "2022-12-16T22:07:03.293862+08:00",
            "Value": 45.833333333333336
          },
          {
            "Time": "2022-12-16T22:07:03.793862+08:00",
            "Value": 47.19101123595506
          },
          {
            "Time": "2022-12-16T22:07:04.293862+08:00",
            "Value": 54.44444444444444
          },
          {
            "Time": "2022-12-16T22:07:04.793862+08:00",
            "Value": 48.148148148148145
          },
          {
            "Time": "2022-12-16T22:07:05.293862+08:00",
            "Value": 52.30769230769231
          },
          {
            "Time": "2022-12-16T22:07:05.793862+08:00",
            "Value": 54
          },
          {
            "Time": "2022-12-16T22:07:06.293862+08:00",
            "Value": 48.717948717948715
          },
          {
            "Time": "2022-12-16T22:07:06.793862+08:00",
            "Value": 50
          },
          {
            "Time": "2022-12-16T22:07:07.293862+08:00",
            "Value": 50.450450450450454
          },
          {
            "Time": "2022-12-16T22:07:07.793862+08:00",
            "Value": 60
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-16T22:07:02.793862+08:00",
            "Value": 47.22222222222222
          },
          {
            "Time": "2022-12-16T22:07:03.293862+08:00",
            "Value": 58.333333333333336
          },
          {
            "Time": "2022-12-16T22:07:03.793862+08:00",
            "Value": 57.142857142857146
          },
          {
            "Time": "2022-12-16T22:07:04.293862+08:00",
            "Value": 41.02564102564103
          },
          {
            "Time": "2022-12-16T22:07:04.793862+08:00",
            "Value": 54.54545454545455
          },
          {
            "Time": "2022-12-16T22:07:05.293862+08:00",
            "Value": 46.15384615384615
          },
          {
            "Time": "2022-12-16T22:07:05.793862+08:00",
            "Value": 37.77777777777778
          },
          {
            "Time": "2022-12-16T22:07:06.293862+08:00",
            "Value": 53.333333333333336
          },
          {
            "Time": "2022-12-16T22:07:06.793862+08:00",
            "Value": 51.515151515151516
          },
          {
            "Time": "2022-12-16T22:07:07.293862+08:00",
            "Value": 50
          },
          {
            "Time": "2022-12-16T22:07:07.793862+08:00",
            "Value": 66.66666666666667
          }
        ]
      },
      "ErrCodeDistribution": {
        "unit1": {
          "OK": 462,
          "val3 val4": 459
        },
        "unit2": {
          "OK": 186,
          "val3 val4": 189
        }
      }
    }
  ]
}`

type metaMetric struct {
	Meta    *recorder.Meta
	Metrics []*recorder.Metric
}

func loadMetaMetric() (meta *recorder.Meta, metrics []*recorder.Metric) {
	var v metaMetric
	jsoniter.UnmarshalFromString(testJson, &v)
	return v.Meta, v.Metrics
}

func TestReporterJson(t *testing.T) {
	meta, metrics := loadMetaMetric()

	Convey("TestReporterJson", t, func() {
		reporter, err := NewReporterWithOptions(&refx.TypeOptions{
			Type: "Json",
		})
		So(err, ShouldBeNil)
		fmt.Println(reporter.Report(meta, metrics))
	})
}

func TestReporterText(t *testing.T) {
	meta, metrics := loadMetaMetric()

	Convey("TestReporterText", t, func() {
		reporter, err := NewReporterWithOptions(&refx.TypeOptions{
			Type: "Text",
			Options: &TextReporterOptions{
				TitleWidth: 20,
				ValueWidth: 9,
			},
		})
		So(err, ShouldBeNil)
		fmt.Println(reporter.Report(meta, metrics))
	})
}

func TestReporterHtml(t *testing.T) {
	meta, metrics := loadMetaMetric()

	Convey("TestReporterHtml", t, func() {
		reporter, err := NewReporterWithOptions(&refx.TypeOptions{
			Type: "Html",
		})
		So(err, ShouldBeNil)
		fmt.Println(reporter.Report(meta, metrics))
	})
}
