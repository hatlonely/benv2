package reporter

import (
	"fmt"
	"io/ioutil"
	"testing"

	"github.com/hatlonely/go-kit/refx"
	jsoniter "github.com/json-iterator/go"
	. "github.com/smartystreets/goconvey/convey"

	"github.com/hatlonely/benv2/internal/recorder"
)

var testJson = `{
  "Meta": {
    "ID": "",
    "Name": "TestFramework",
    "Duration": 5000000000,
    "Parallel": [
      {
        "unit1": 3,
        "unit2": 1
      },
      {
        "unit1": 5,
        "unit2": 2
      }
    ],
    "TimeRange": [
      {
        "StartTime": "2022-12-18T16:33:57.516079+08:00",
        "EndTime": "2022-12-18T16:34:02.516079+08:00"
      },
      {
        "StartTime": "2022-12-18T16:34:03.516079+08:00",
        "EndTime": "2022-12-18T16:34:08.516079+08:00"
      }
    ]
  },
  "Metrics": [
    {
      "Summary": {
        "unit1": {
          "Total": 1205,
          "Pass": 600,
          "QPS": 120,
          "AvgResTimeMs": 16.18,
          "SuccessRatePercent": 49.79253112033195
        },
        "unit2": {
          "Total": 403,
          "Pass": 203,
          "QPS": 40.6,
          "AvgResTimeMs": 16.113300492610836,
          "SuccessRatePercent": 50.37220843672456
        }
      },
      "QPS": {
        "unit1": [
          {
            "Time": "2022-12-18T16:33:57.516079+08:00",
            "Value": 114
          },
          {
            "Time": "2022-12-18T16:33:58.016079+08:00",
            "Value": 142
          },
          {
            "Time": "2022-12-18T16:33:58.516079+08:00",
            "Value": 118
          },
          {
            "Time": "2022-12-18T16:33:59.016079+08:00",
            "Value": 116
          },
          {
            "Time": "2022-12-18T16:33:59.516079+08:00",
            "Value": 120
          },
          {
            "Time": "2022-12-18T16:34:00.016079+08:00",
            "Value": 126
          },
          {
            "Time": "2022-12-18T16:34:00.516079+08:00",
            "Value": 116
          },
          {
            "Time": "2022-12-18T16:34:01.016079+08:00",
            "Value": 110
          },
          {
            "Time": "2022-12-18T16:34:01.516079+08:00",
            "Value": 112
          },
          {
            "Time": "2022-12-18T16:34:02.016079+08:00",
            "Value": 126
          },
          {
            "Time": "2022-12-18T16:34:02.516079+08:00",
            "Value": 4
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-18T16:33:57.516079+08:00",
            "Value": 38
          },
          {
            "Time": "2022-12-18T16:33:58.016079+08:00",
            "Value": 46
          },
          {
            "Time": "2022-12-18T16:33:58.516079+08:00",
            "Value": 40
          },
          {
            "Time": "2022-12-18T16:33:59.016079+08:00",
            "Value": 38
          },
          {
            "Time": "2022-12-18T16:33:59.516079+08:00",
            "Value": 48
          },
          {
            "Time": "2022-12-18T16:34:00.016079+08:00",
            "Value": 40
          },
          {
            "Time": "2022-12-18T16:34:00.516079+08:00",
            "Value": 34
          },
          {
            "Time": "2022-12-18T16:34:01.016079+08:00",
            "Value": 42
          },
          {
            "Time": "2022-12-18T16:34:01.516079+08:00",
            "Value": 42
          },
          {
            "Time": "2022-12-18T16:34:02.016079+08:00",
            "Value": 38
          },
          {
            "Time": "2022-12-18T16:34:02.516079+08:00",
            "Value": 2
          }
        ]
      },
      "AvgResTimeMs": {
        "unit1": [
          {
            "Time": "2022-12-18T16:33:57.516079+08:00",
            "Value": 15.87719298245614
          },
          {
            "Time": "2022-12-18T16:33:58.016079+08:00",
            "Value": 14.647887323943662
          },
          {
            "Time": "2022-12-18T16:33:58.516079+08:00",
            "Value": 16.338983050847457
          },
          {
            "Time": "2022-12-18T16:33:59.016079+08:00",
            "Value": 17.06896551724138
          },
          {
            "Time": "2022-12-18T16:33:59.516079+08:00",
            "Value": 15.566666666666666
          },
          {
            "Time": "2022-12-18T16:34:00.016079+08:00",
            "Value": 15.80952380952381
          },
          {
            "Time": "2022-12-18T16:34:00.516079+08:00",
            "Value": 17.517241379310345
          },
          {
            "Time": "2022-12-18T16:34:01.016079+08:00",
            "Value": 17.21818181818182
          },
          {
            "Time": "2022-12-18T16:34:01.516079+08:00",
            "Value": 16.696428571428573
          },
          {
            "Time": "2022-12-18T16:34:02.016079+08:00",
            "Value": 15.476190476190476
          },
          {
            "Time": "2022-12-18T16:34:02.516079+08:00",
            "Value": 11.5
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-18T16:33:57.516079+08:00",
            "Value": 16.42105263157895
          },
          {
            "Time": "2022-12-18T16:33:58.016079+08:00",
            "Value": 13.565217391304348
          },
          {
            "Time": "2022-12-18T16:33:58.516079+08:00",
            "Value": 16.35
          },
          {
            "Time": "2022-12-18T16:33:59.016079+08:00",
            "Value": 16.473684210526315
          },
          {
            "Time": "2022-12-18T16:33:59.516079+08:00",
            "Value": 15.458333333333334
          },
          {
            "Time": "2022-12-18T16:34:00.016079+08:00",
            "Value": 15.6
          },
          {
            "Time": "2022-12-18T16:34:00.516079+08:00",
            "Value": 16.470588235294116
          },
          {
            "Time": "2022-12-18T16:34:01.016079+08:00",
            "Value": 16.714285714285715
          },
          {
            "Time": "2022-12-18T16:34:01.516079+08:00",
            "Value": 17.523809523809526
          },
          {
            "Time": "2022-12-18T16:34:02.016079+08:00",
            "Value": 16.894736842105264
          },
          {
            "Time": "2022-12-18T16:34:02.516079+08:00",
            "Value": 11
          }
        ]
      },
      "SuccessRatePercent": {
        "unit1": [
          {
            "Time": "2022-12-18T16:33:57.516079+08:00",
            "Value": 49.56521739130435
          },
          {
            "Time": "2022-12-18T16:33:58.016079+08:00",
            "Value": 49.65034965034965
          },
          {
            "Time": "2022-12-18T16:33:58.516079+08:00",
            "Value": 50.427350427350426
          },
          {
            "Time": "2022-12-18T16:33:59.016079+08:00",
            "Value": 50.43478260869565
          },
          {
            "Time": "2022-12-18T16:33:59.516079+08:00",
            "Value": 47.24409448818898
          },
          {
            "Time": "2022-12-18T16:34:00.016079+08:00",
            "Value": 50.806451612903224
          },
          {
            "Time": "2022-12-18T16:34:00.516079+08:00",
            "Value": 53.211009174311926
          },
          {
            "Time": "2022-12-18T16:34:01.016079+08:00",
            "Value": 47.82608695652174
          },
          {
            "Time": "2022-12-18T16:34:01.516079+08:00",
            "Value": 48.275862068965516
          },
          {
            "Time": "2022-12-18T16:34:02.016079+08:00",
            "Value": 50.806451612903224
          },
          {
            "Time": "2022-12-18T16:34:02.516079+08:00",
            "Value": 66.66666666666667
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-18T16:33:57.516079+08:00",
            "Value": 48.717948717948715
          },
          {
            "Time": "2022-12-18T16:33:58.016079+08:00",
            "Value": 51.111111111111114
          },
          {
            "Time": "2022-12-18T16:33:58.516079+08:00",
            "Value": 48.78048780487805
          },
          {
            "Time": "2022-12-18T16:33:59.016079+08:00",
            "Value": 48.717948717948715
          },
          {
            "Time": "2022-12-18T16:33:59.516079+08:00",
            "Value": 58.53658536585366
          },
          {
            "Time": "2022-12-18T16:34:00.016079+08:00",
            "Value": 46.51162790697674
          },
          {
            "Time": "2022-12-18T16:34:00.516079+08:00",
            "Value": 43.58974358974359
          },
          {
            "Time": "2022-12-18T16:34:01.016079+08:00",
            "Value": 55.26315789473684
          },
          {
            "Time": "2022-12-18T16:34:01.516079+08:00",
            "Value": 56.75675675675676
          },
          {
            "Time": "2022-12-18T16:34:02.016079+08:00",
            "Value": 46.34146341463415
          },
          {
            "Time": "2022-12-18T16:34:02.516079+08:00",
            "Value": 100
          }
        ]
      },
      "ErrCodeDistribution": {
        "unit1": {
          "OK": 602,
          "val3 val4": 606
        },
        "unit2": {
          "OK": 204,
          "val3 val4": 200
        }
      }
    },
    {
      "Summary": {
        "unit1": {
          "Total": 935,
          "Pass": 479,
          "QPS": 95.8,
          "AvgResTimeMs": 33.06680584551148,
          "SuccessRatePercent": 51.22994652406417
        },
        "unit2": {
          "Total": 381,
          "Pass": 178,
          "QPS": 35.6,
          "AvgResTimeMs": 33.449438202247194,
          "SuccessRatePercent": 46.71916010498688
        }
      },
      "QPS": {
        "unit1": [
          {
            "Time": "2022-12-18T16:34:03.516079+08:00",
            "Value": 98
          },
          {
            "Time": "2022-12-18T16:34:04.016079+08:00",
            "Value": 98
          },
          {
            "Time": "2022-12-18T16:34:04.516079+08:00",
            "Value": 104
          },
          {
            "Time": "2022-12-18T16:34:05.016079+08:00",
            "Value": 96
          },
          {
            "Time": "2022-12-18T16:34:05.516079+08:00",
            "Value": 90
          },
          {
            "Time": "2022-12-18T16:34:06.016079+08:00",
            "Value": 90
          },
          {
            "Time": "2022-12-18T16:34:06.516079+08:00",
            "Value": 104
          },
          {
            "Time": "2022-12-18T16:34:07.016079+08:00",
            "Value": 94
          },
          {
            "Time": "2022-12-18T16:34:07.516079+08:00",
            "Value": 88
          },
          {
            "Time": "2022-12-18T16:34:08.016079+08:00",
            "Value": 96
          },
          {
            "Time": "2022-12-18T16:34:08.516079+08:00",
            "Value": 4
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-18T16:34:03.516079+08:00",
            "Value": 30
          },
          {
            "Time": "2022-12-18T16:34:04.016079+08:00",
            "Value": 42
          },
          {
            "Time": "2022-12-18T16:34:04.516079+08:00",
            "Value": 40
          },
          {
            "Time": "2022-12-18T16:34:05.016079+08:00",
            "Value": 36
          },
          {
            "Time": "2022-12-18T16:34:05.516079+08:00",
            "Value": 36
          },
          {
            "Time": "2022-12-18T16:34:06.016079+08:00",
            "Value": 34
          },
          {
            "Time": "2022-12-18T16:34:06.516079+08:00",
            "Value": 26
          },
          {
            "Time": "2022-12-18T16:34:07.016079+08:00",
            "Value": 32
          },
          {
            "Time": "2022-12-18T16:34:07.516079+08:00",
            "Value": 46
          },
          {
            "Time": "2022-12-18T16:34:08.016079+08:00",
            "Value": 34
          },
          {
            "Time": "2022-12-18T16:34:08.516079+08:00",
            "Value": 4
          }
        ]
      },
      "AvgResTimeMs": {
        "unit1": [
          {
            "Time": "2022-12-18T16:34:03.516079+08:00",
            "Value": 32.30612244897959
          },
          {
            "Time": "2022-12-18T16:34:04.016079+08:00",
            "Value": 30.816326530612244
          },
          {
            "Time": "2022-12-18T16:34:04.516079+08:00",
            "Value": 30.076923076923077
          },
          {
            "Time": "2022-12-18T16:34:05.016079+08:00",
            "Value": 32.875
          },
          {
            "Time": "2022-12-18T16:34:05.516079+08:00",
            "Value": 35.22222222222222
          },
          {
            "Time": "2022-12-18T16:34:06.016079+08:00",
            "Value": 36.17777777777778
          },
          {
            "Time": "2022-12-18T16:34:06.516079+08:00",
            "Value": 34.76923076923077
          },
          {
            "Time": "2022-12-18T16:34:07.016079+08:00",
            "Value": 33.255319148936174
          },
          {
            "Time": "2022-12-18T16:34:07.516079+08:00",
            "Value": 32.63636363636363
          },
          {
            "Time": "2022-12-18T16:34:08.016079+08:00",
            "Value": 32.895833333333336
          },
          {
            "Time": "2022-12-18T16:34:08.516079+08:00",
            "Value": 100.5
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-18T16:34:03.516079+08:00",
            "Value": 31.333333333333332
          },
          {
            "Time": "2022-12-18T16:34:04.016079+08:00",
            "Value": 33
          },
          {
            "Time": "2022-12-18T16:34:04.516079+08:00",
            "Value": 29.7
          },
          {
            "Time": "2022-12-18T16:34:05.016079+08:00",
            "Value": 34.333333333333336
          },
          {
            "Time": "2022-12-18T16:34:05.516079+08:00",
            "Value": 33.22222222222222
          },
          {
            "Time": "2022-12-18T16:34:06.016079+08:00",
            "Value": 36.1764705882353
          },
          {
            "Time": "2022-12-18T16:34:06.516079+08:00",
            "Value": 36.46153846153846
          },
          {
            "Time": "2022-12-18T16:34:07.016079+08:00",
            "Value": 35.1875
          },
          {
            "Time": "2022-12-18T16:34:07.516079+08:00",
            "Value": 32.91304347826087
          },
          {
            "Time": "2022-12-18T16:34:08.016079+08:00",
            "Value": 33.411764705882355
          },
          {
            "Time": "2022-12-18T16:34:08.516079+08:00",
            "Value": 95.5
          }
        ]
      },
      "SuccessRatePercent": {
        "unit1": [
          {
            "Time": "2022-12-18T16:34:03.516079+08:00",
            "Value": 53.26086956521739
          },
          {
            "Time": "2022-12-18T16:34:04.016079+08:00",
            "Value": 48.03921568627451
          },
          {
            "Time": "2022-12-18T16:34:04.516079+08:00",
            "Value": 50.98039215686274
          },
          {
            "Time": "2022-12-18T16:34:05.016079+08:00",
            "Value": 51.61290322580645
          },
          {
            "Time": "2022-12-18T16:34:05.516079+08:00",
            "Value": 51.13636363636363
          },
          {
            "Time": "2022-12-18T16:34:06.016079+08:00",
            "Value": 51.724137931034484
          },
          {
            "Time": "2022-12-18T16:34:06.516079+08:00",
            "Value": 57.77777777777778
          },
          {
            "Time": "2022-12-18T16:34:07.016079+08:00",
            "Value": 52.22222222222222
          },
          {
            "Time": "2022-12-18T16:34:07.516079+08:00",
            "Value": 44
          },
          {
            "Time": "2022-12-18T16:34:08.016079+08:00",
            "Value": 52.747252747252745
          },
          {
            "Time": "2022-12-18T16:34:08.516079+08:00",
            "Value": 40
          }
        ],
        "unit2": [
          {
            "Time": "2022-12-18T16:34:03.516079+08:00",
            "Value": 38.46153846153846
          },
          {
            "Time": "2022-12-18T16:34:04.016079+08:00",
            "Value": 55.26315789473684
          },
          {
            "Time": "2022-12-18T16:34:04.516079+08:00",
            "Value": 48.78048780487805
          },
          {
            "Time": "2022-12-18T16:34:05.016079+08:00",
            "Value": 46.15384615384615
          },
          {
            "Time": "2022-12-18T16:34:05.516079+08:00",
            "Value": 45
          },
          {
            "Time": "2022-12-18T16:34:06.016079+08:00",
            "Value": 47.22222222222222
          },
          {
            "Time": "2022-12-18T16:34:06.516079+08:00",
            "Value": 34.21052631578947
          },
          {
            "Time": "2022-12-18T16:34:07.016079+08:00",
            "Value": 43.24324324324324
          },
          {
            "Time": "2022-12-18T16:34:07.516079+08:00",
            "Value": 67.6470588235294
          },
          {
            "Time": "2022-12-18T16:34:08.016079+08:00",
            "Value": 43.58974358974359
          },
          {
            "Time": "2022-12-18T16:34:08.516079+08:00",
            "Value": 100
          }
        ]
      },
      "ErrCodeDistribution": {
        "unit1": {
          "OK": 481,
          "val3 val4": 459
        },
        "unit2": {
          "OK": 180,
          "val3 val4": 203
        }
      }
    }
  ],
  "Monitors": [
    {
      "acs_ecs_dashboard.CPUUtilization": [
        {
          "Time": "2022-12-18T16:25:00+08:00",
          "Value": 6.524
        },
        {
          "Time": "2022-12-18T16:26:00+08:00",
          "Value": 6.639
        },
        {
          "Time": "2022-12-18T16:27:00+08:00",
          "Value": 6.531
        },
        {
          "Time": "2022-12-18T16:28:00+08:00",
          "Value": 6.568
        },
        {
          "Time": "2022-12-18T16:29:00+08:00",
          "Value": 6.622
        },
        {
          "Time": "2022-12-18T16:30:00+08:00",
          "Value": 6.837
        },
        {
          "Time": "2022-12-18T16:31:00+08:00",
          "Value": 6.685
        },
        {
          "Time": "2022-12-18T16:32:00+08:00",
          "Value": 6.52
        },
        {
          "Time": "2022-12-18T16:33:00+08:00",
          "Value": 6.429
        },
        {
          "Time": "2022-12-18T16:34:00+08:00",
          "Value": 6.543
        }
      ]
    },
    {
      "acs_ecs_dashboard.CPUUtilization": [
        {
          "Time": "2022-12-18T16:25:00+08:00",
          "Value": 6.524
        },
        {
          "Time": "2022-12-18T16:26:00+08:00",
          "Value": 6.639
        },
        {
          "Time": "2022-12-18T16:27:00+08:00",
          "Value": 6.531
        },
        {
          "Time": "2022-12-18T16:28:00+08:00",
          "Value": 6.568
        },
        {
          "Time": "2022-12-18T16:29:00+08:00",
          "Value": 6.622
        },
        {
          "Time": "2022-12-18T16:30:00+08:00",
          "Value": 6.837
        },
        {
          "Time": "2022-12-18T16:31:00+08:00",
          "Value": 6.685
        },
        {
          "Time": "2022-12-18T16:32:00+08:00",
          "Value": 6.52
        },
        {
          "Time": "2022-12-18T16:33:00+08:00",
          "Value": 6.429
        },
        {
          "Time": "2022-12-18T16:34:00+08:00",
          "Value": 6.543
        }
      ]
    }
  ]
}`

type metaMetric struct {
	Meta     *recorder.Meta
	Metrics  []*recorder.Metric
	Monitors []map[string][]*recorder.Measurement
}

func loadMetaMetric() (meta *recorder.Meta, metrics []*recorder.Metric, monitors []map[string][]*recorder.Measurement) {
	var v metaMetric
	jsoniter.UnmarshalFromString(testJson, &v)
	return v.Meta, v.Metrics, v.Monitors
}

func TestReporterJson(t *testing.T) {
	meta, metrics, monitors := loadMetaMetric()

	Convey("TestReporterJson", t, func() {
		reporter, err := NewReporterWithOptions(&refx.TypeOptions{
			Type: "Json",
		})
		So(err, ShouldBeNil)
		fmt.Println(reporter.Report(meta, metrics, monitors))
	})
}

func TestReporterText(t *testing.T) {
	meta, metrics, monitors := loadMetaMetric()

	Convey("TestReporterText", t, func() {
		reporter, err := NewReporterWithOptions(&refx.TypeOptions{
			Type: "Text",
			Options: &TextReporterOptions{
				TitleWidth: 20,
				ValueWidth: 9,
			},
		})
		So(err, ShouldBeNil)
		fmt.Println(reporter.Report(meta, metrics, monitors))
	})
}

func TestReporterHtml(t *testing.T) {
	meta, metrics, monitors := loadMetaMetric()

	Convey("TestReporterHtml", t, func() {
		reporter, err := NewReporterWithOptions(&refx.TypeOptions{
			Type: "Html",
		})
		So(err, ShouldBeNil)
		ioutil.WriteFile("1.html", []byte(reporter.Report(meta, metrics, monitors)), 0644)
	})
}
